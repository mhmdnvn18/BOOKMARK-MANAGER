<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookmark Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <script>
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'login.html';
        }
    </script>
    <header class="bg-primary text-white p-3 mb-4" role="banner">
        <div class="container d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="h3">Bookmark Manager</h1>
            <div class="header-buttons d-flex align-items-center flex-wrap">
                <input type="text" id="search-input" class="form-control me-2" placeholder="Search bookmarks..." aria-label="Search bookmarks">
                <button id="theme-toggle" class="btn btn-secondary" aria-label="Toggle dark mode"><i class="fa-solid fa-moon"></i></button>
                <button class="btn btn-danger ms-2" onclick="logout()" aria-label="Logout">Logout</button>
                <a href="research.html" class="btn btn-info ms-2" aria-label="Research Manager">Research Manager</a>
            </div>
        </div>
    </header>
    <main class="container" role="main">
        <section id="add-bookmark" class="mb-4 dark-mode-section">
            <h2 class="h4">Add Bookmark</h2>
            <form id="bookmark-form" class="form">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" class="form-control" placeholder="Title" required>
                </div>
                <div class="form-group">
                    <label for="url">URL</label>
                    <input type="url" id="url" class="form-control" placeholder="URL" required>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" class="form-control" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Work">Work</option>
                        <option value="Personal">Personal</option>
                        <option value="Education">Education</option>
                        <option value="Entertainment">Entertainment</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Bookmark</button>
            </form>
        </section>
        <section id="edit-bookmark" class="mb-4 dark-mode-section" style="display: none;">
            <h2 class="h4">Edit Bookmark</h2>
            <form id="edit-bookmark-form" class="form">
                <div class="form-group">
                    <label for="edit-title">Title</label>
                    <input type="text" id="edit-title" class="form-control" placeholder="Title" required>
                </div>
                <div class="form-group">
                    <label for="edit-url">URL</label>
                    <input type="url" id="edit-url" class="form-control" placeholder="URL" required>
                </div>
                <div class="form-group">
                    <label for="edit-category">Category</label>
                    <select id="edit-category" class="form-control" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Work">Work</option>
                        <option value="Personal">Personal</option>
                        <option value="Education">Education</option>
                        <option value="Entertainment">Entertainment</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" id="cancel-edit" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </section>
        <section id="bookmarks" class="dark-mode-section">
            <h2 class="h4">Bookmarks</h2>
            <div id="bookmark-list" class="row"></div>
        </section>
    </main>
    <footer class="bg-primary text-white text-center p-3 mt-4" role="contentinfo">
        <div class="container">
            <p>&copy; 2025 Bookmark Manager. All rights reserved.</p>
        </div>
    </footer>
    <div id="confirmation-dialog" class="confirmation-dialog" style="display: none;">
        <p>Are you sure you want to delete this bookmark?</p>
        <button id="confirm-delete" class="btn btn-danger">Yes</button>
        <button id="cancel-delete" class="btn btn-secondary">No</button>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSyI1drQSWkU1192Ol_7UnOztxxTZkerQ",
            authDomain: "bookmark-manager-7c5ab.firebaseapp.com",
            projectId: "bookmark-manager-7c5ab",
            storageBucket: "bookmark-manager-7c5ab.firebasestorage.app",
            messagingSenderId: "1098246411927",
            appId: "1:1098246411927:web:9a44915017f9d35fbefbd2",
            measurementId: "G-YF6CS3N1C6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('bookmark-form');
            const editForm = document.getElementById('edit-bookmark-form');
            const bookmarkList = document.getElementById('bookmark-list');
            const themeToggle = document.getElementById('theme-toggle');
            const searchInput = document.getElementById('search-input');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmDeleteButton = document.getElementById('confirm-delete');
            const cancelDeleteButton = document.getElementById('cancel-delete');
            let editIndex = null;
            let deleteIndex = null;

            async function displayBookmarks(searchTerm = '') {
                bookmarkList.innerHTML = '';
                const querySnapshot = await getDocs(collection(db, 'bookmarks'));
                const categories = {};
                querySnapshot.forEach((doc) => {
                    const bookmark = doc.data();
                    if (bookmark.title.toLowerCase().includes(searchTerm.toLowerCase()) || bookmark.url.toLowerCase().includes(searchTerm.toLowerCase())) {
                        if (!categories[bookmark.category]) {
                            categories[bookmark.category] = [];
                        }
                        categories[bookmark.category].push({ ...bookmark, id: doc.id });
                    }
                });

                const categoryContainer = document.createElement('div');
                categoryContainer.classList.add('category-container');

                for (const category in categories) {
                    const categorySection = document.createElement('div');
                    categorySection.classList.add('category-section');
                    categorySection.innerHTML = `<h3 class="category-title">${category} (${categories[category].length})</h3>`;

                    categories[category].forEach(bookmark => {
                        const bookmarkElement = document.createElement('div');
                        bookmarkElement.classList.add('card', 'text-bg-primary', 'mb-3');
                        bookmarkElement.style.maxWidth = '18rem';
                        bookmarkElement.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">
                                    <img src="https://www.google.com/s2/favicons?domain=${bookmark.url}" class="favicon" alt="Favicon">
                                    ${bookmark.title}
                                </h5>
                                <p class="card-text">
                                    <a href="${bookmark.url}" class="bookmark-url" target="_blank">${bookmark.url}</a>
                                </p>
                                <p class="card-text">
                                    <span class="bookmark-category">${bookmark.category}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            Actions
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton${bookmark.id}">
                                            <li><button class="dropdown-item" type="button" onclick="editBookmark('${bookmark.id}')">Edit</button></li>
                                            <li><button class="dropdown-item" type="button" onclick="showConfirmationDialog('${bookmark.id}')">Delete</button></li>
                                            <li><button class="dropdown-item" type="button" onclick="shareBookmark('${bookmark.url}', '${bookmark.title}')">Share</button></li>
                                        </ul>
                                    </div>
                                </p>
                            </div>
                        `;
                        if (document.body.classList.contains('dark-mode')) {
                            bookmarkElement.classList.add('dark-mode');
                        }
                        categorySection.appendChild(bookmarkElement);
                    });

                    categoryContainer.appendChild(categorySection);
                }

                bookmarkList.appendChild(categoryContainer);
            }

            window.deleteBookmark = async function(id) {
                await deleteDoc(doc(db, 'bookmarks', id));
                displayBookmarks();
            }

            window.editBookmark = async function(id) {
                editIndex = id;
                const docSnap = await getDoc(doc(db, 'bookmarks', id));
                const bookmark = docSnap.data();
                document.getElementById('edit-title').value = bookmark.title;
                document.getElementById('edit-url').value = bookmark.url;
                document.getElementById('edit-category').value = bookmark.category;
                document.getElementById('edit-bookmark').style.display = 'block';
            }

            window.showConfirmationDialog = function(id) {
                deleteIndex = id;
                confirmationDialog.style.display = 'block';
            }

            confirmDeleteButton.addEventListener('click', async function() {
                await deleteDoc(doc(db, 'bookmarks', deleteIndex));
                confirmationDialog.style.display = 'none';
                displayBookmarks();
            });

            cancelDeleteButton.addEventListener('click', function() {
                confirmationDialog.style.display = 'none';
            });

            editForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const title = document.getElementById('edit-title').value;
                const url = document.getElementById('edit-url').value;
                const category = document.getElementById('edit-category').value;
                await updateDoc(doc(db, 'bookmarks', editIndex), { title, url, category });
                displayBookmarks();
                editForm.reset();
                document.getElementById('edit-bookmark').style.display = 'none';
            });

            document.getElementById('cancel-edit').addEventListener('click', function() {
                document.getElementById('edit-bookmark').style.display = 'none';
            });

            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const title = document.getElementById('title').value;
                const url = document.getElementById('url').value;
                const category = document.getElementById('category').value;
                console.log('Adding bookmark:', { title, url, category });
                try {
                    await addDoc(collection(db, 'bookmarks'), { title, url, category });
                    console.log('Bookmark added successfully');
                    displayBookmarks();
                    form.reset();
                } catch (error) {
                    console.error('Error adding bookmark:', error);
                }
            });

            window.logout = function() {
                localStorage.removeItem('loggedIn');
                window.location.href = 'login.html';
            }

            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark-mode');
                document.querySelectorAll('section').forEach(section => {
                    section.classList.toggle('dark-mode');
                });
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.toggle('dark-mode');
                });
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelectorAll('section').forEach(section => {
                    section.classList.add('dark-mode');
                });
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.add('dark-mode');
                });
            }

            searchInput.addEventListener('input', function() {
                displayBookmarks(searchInput.value);
            });

            displayBookmarks();
        });

        window.shareBookmark = function(url, title) {
            const shareData = {
                title: title,
                text: `Check out this bookmark: ${title}`,
                url: url
            };

            if (navigator.share) {
                navigator.share(shareData).catch(console.error);
            } else {
                const mailtoLink = `mailto:?subject=${encodeURIComponent(shareData.title)}&body=${encodeURIComponent(shareData.text)}%0A${encodeURIComponent(shareData.url)}`;
                window.location.href = mailtoLink;
            }
        }
    </script>
</body>
</html>